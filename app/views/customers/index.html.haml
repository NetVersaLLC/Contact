%h1 Listing customers
.widget-box 
  .widget-header 
    %h4 Search 
  .widget-body
    .widget-main
      -#=search_form_for @q, url: customers_path, class:"form-search" do |f|
        .input-group
          =f.text_field :business_name_cont,  placeholder: "Business Name", class: "form-control search-query"
          %span.input-group-btn
            %button.btn.btn-purple.btn-sm
              Search
              %i.icon-search.icon-on-right.bigger-110
      .space-6
      %select#business_id.chosen-select

.dataTables_wrapper
  %table.table.table-striped.table-bordered.table-hover.dataTable
    %thead
      %tr
        %th Name
        %th Business ID
        %th Client Checked In
        %th Client Version
        %th Categorized?
        %th Subscription
        %th
        %th
        %th
        %th
        %th 
    %tbody 
      - @customers.each do |customer|
        %tr
          %td
            = link_to customer.business_name, edit_business_path(customer)
          %td= customer.id.to_s
          %td= (customer.client_checkin.nil? ? 'No' : 'Yes')
          %td= customer.client_version
          %td= customer.categorized? ? 'Yes' : 'No'
          %td= customer.subscription.present? && customer.subscription.active ? "Active":"Inactive"
          %td= link_to 'Show', customer
          %td= link_to 'Edit', edit_business_path(customer)
          %td= link_to 'Categorize', "/categories?business_id=#{customer.id}"
          %td= link_to 'CM', "/client_manager?business_id=#{customer.id}"
          %td
            -if customer.user.present? 
              =link_to 'Impersonate', new_impersonation_path(customer.user)
            - else 
              No Owner Assigned
  .row 
    .col-xs-5
      .dataTables_info
        = page_entries_info @customers
    .col-xs-7
      .dataTables_paginate.paging_bootstrap
        = will_paginate @customers, previous_label: "<", next_label: ">", inner_window: 1, outer_window: 1

:javascript 
  window.business_id = #{params[:q] ? params[:q][:id_eq]:'""'};

  $( function() {  
    options_template = Handlebars.compile($("#options-template").html()); 

    $.getJSON("/businesses.json", function(data) {  
      $("#business_id").html( options_template(data));
      $("#business_id").val( window.business_id ); 

      $(".chosen-select").chosen();

      $("#business_id").on( 'change', function() {  
        window.location.href = "/customers?q[id_eq]=" + $(this).val()
      } );
      }); 
  });

%script{id: "options-template", type: "text/x-handlebars-template"} 
  {{#each businesses}}
  %option{ value: "{{id}}" } {{business_name}} ( {{id}} )
  {{/each}}


