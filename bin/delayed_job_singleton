#!/usr/bin/env ruby
 
PRESUMPTIVE_RAILS_ROOT = "/Users/jjeffus/dev/contact"
LOG_PATH = "#{PRESUMPTIVE_RAILS_ROOT}/log/delayed_job_singleton.log"
 
Dir.chdir PRESUMPTIVE_RAILS_ROOT
 
require 'home_run'
require "rubygems"
require "bundler/setup"
require 'daemon_spawn'
 
class DelayedJobSingleton < DaemonSpawn::Base
  def start(args)
    require "#{PRESUMPTIVE_RAILS_ROOT}/config/environment.rb"
    f = open LOG_PATH, (File::WRONLY | File::APPEND | File::CREAT)
    f.sync = true
    Rails.logger.auto_flushing = true
    Delayed::Worker.logger = Rails.logger
    Delayed::Worker.new(:quiet => true).start
  end
 
  def stop
  end
end
 
DelayedJobSingleton.spawn!(:log_file => LOG_PATH,
                           :pid_file => "#{PRESUMPTIVE_RAILS_ROOT}/tmp/delayed_job_singleton.pid",
                           :sync_log => true,
                           :working_dir => PRESUMPTIVE_RAILS_ROOT,
                           :singleton => true,
                           :timeout => 90,
                           :signal => 'INT')

